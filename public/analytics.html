<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - PathSynch Pitch Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #3A6746 0%, #6B4423 100%);
            color: white;
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 24px; font-weight: 600; }
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .header-actions a, .header-actions button {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        .header-actions a:hover, .header-actions button:hover {
            background: rgba(255,255,255,0.3);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }
        .page-title {
            color: #3A6746;
            font-size: 28px;
            margin-bottom: 24px;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }
        .summary-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .summary-card-label {
            font-size: 13px;
            color: #888;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .summary-card-value {
            font-size: 36px;
            font-weight: 700;
            color: #3A6746;
        }
        .summary-card-change {
            font-size: 13px;
            margin-top: 8px;
        }
        .summary-card-change.positive { color: #22c55e; }
        .summary-card-change.negative { color: #ef4444; }
        .summary-card-change.neutral { color: #888; }

        /* Charts Section */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }
        .chart-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .chart-card h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .chart-container {
            height: 250px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 20px 0;
        }
        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #3A6746, #5a9766);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 4px;
            transition: height 0.3s;
        }
        .chart-bar:hover {
            background: linear-gradient(to top, #2d5136, #4a8756);
        }
        .chart-bar-label {
            position: absolute;
            bottom: -24px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #888;
            white-space: nowrap;
        }
        .chart-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: 600;
            color: #333;
        }

        /* Donut Chart */
        .donut-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            padding: 20px;
        }
        .donut-chart {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            position: relative;
        }
        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .donut-center-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }
        .donut-center-label {
            font-size: 11px;
            color: #888;
        }
        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .legend-dot.level-1 { background: #22c55e; }
        .legend-dot.level-2 { background: #3b82f6; }
        .legend-dot.level-3 { background: #f59e0b; }

        /* Top Pitches Table */
        .table-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .table-card h3 {
            color: #333;
            font-size: 16px;
            margin-bottom: 20px;
        }
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
        }
        .analytics-table th {
            text-align: left;
            padding: 12px;
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #eee;
        }
        .analytics-table td {
            padding: 16px 12px;
            font-size: 14px;
            border-bottom: 1px solid #f5f5f5;
        }
        .analytics-table tr:last-child td {
            border-bottom: none;
        }
        .analytics-table .business-name {
            font-weight: 600;
            color: #333;
        }
        .analytics-table .level-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        .level-badge.level-1 { background: #e8f5e9; color: #2e7d32; }
        .level-badge.level-2 { background: #e3f2fd; color: #1565c0; }
        .level-badge.level-3 { background: #fff3e0; color: #e65100; }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #888;
        }

        @media (max-width: 900px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                gap: 16px;
            }
            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>PathSynch Analytics</h1>
        <div class="header-actions">
            <a href="/dashboard.html">Dashboard</a>
            <a href="/settings.html">Settings</a>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <h2 class="page-title">Analytics Overview</h2>

        <div id="loading" class="loading">
            <p>Loading analytics...</p>
        </div>

        <div id="analyticsContent" style="display: none;">
            <!-- Summary Cards -->
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-card-label">Total Pitches</div>
                    <div class="summary-card-value" id="totalPitches">0</div>
                    <div class="summary-card-change neutral" id="pitchesChange">All time</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Total Views</div>
                    <div class="summary-card-value" id="totalViews">0</div>
                    <div class="summary-card-change neutral" id="viewsChange">Across all pitches</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">Avg. Views/Pitch</div>
                    <div class="summary-card-value" id="avgViews">0</div>
                    <div class="summary-card-change neutral">Per pitch</div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-label">This Month</div>
                    <div class="summary-card-value" id="thisMonth">0</div>
                    <div class="summary-card-change" id="monthChange">Pitches created</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Pitches Created (Last 6 Months)</h3>
                    <div class="chart-container" id="monthlyChart"></div>
                </div>
                <div class="chart-card">
                    <h3>By Pitch Level</h3>
                    <div class="donut-container">
                        <div class="donut-chart" id="levelDonut"></div>
                        <div class="donut-legend" id="levelLegend"></div>
                    </div>
                </div>
            </div>

            <!-- Top Viewed Pitches -->
            <div class="table-card">
                <h3>Top Viewed Pitches</h3>
                <table class="analytics-table">
                    <thead>
                        <tr>
                            <th>Business</th>
                            <th>Level</th>
                            <th>Industry</th>
                            <th>Views</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="topPitchesTable"></tbody>
                </table>
                <div id="noDataMessage" class="empty-state" style="display: none;">
                    <p>No pitches yet. Create your first pitch to see analytics!</p>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA8fBm7lu9WK_ImsAdGPthztJ7F07pzDJY",
            authDomain: "pathsynch-pitch-creation.firebaseapp.com",
            projectId: "pathsynch-pitch-creation",
            storageBucket: "pathsynch-pitch-creation.firebasestorage.app",
            messagingSenderId: "796921234100",
            appId: "1:796921234100:web:6e9862fa2194d2c8ae0de1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.logout = async () => {
            await signOut(auth);
            window.location.href = '/login.html';
        };

        function getPitchLevel(pitch) {
            const level = pitch.pitchLevel || pitch.pitch_level || 3;
            if (typeof level === 'string') {
                if (level.includes('1') || level === 'outreach') return 1;
                if (level.includes('2') || level === 'one-pager') return 2;
                return 3;
            }
            return parseInt(level) || 3;
        }

        function getLevelLabel(level) {
            switch(level) {
                case 1: return 'L1';
                case 2: return 'L2';
                case 3: return 'L3';
                default: return 'L3';
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function getMonthLabel(date) {
            return date.toLocaleDateString('en-US', { month: 'short' });
        }

        function renderMonthlyChart(pitches) {
            const container = document.getElementById('monthlyChart');
            const now = new Date();
            const months = [];

            // Get last 6 months
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                months.push({
                    date: d,
                    label: getMonthLabel(d),
                    count: 0
                });
            }

            // Count pitches per month
            pitches.forEach(pitch => {
                const created = pitch.createdAt?.toDate?.() || null;
                if (!created) return;

                months.forEach(m => {
                    if (created.getFullYear() === m.date.getFullYear() &&
                        created.getMonth() === m.date.getMonth()) {
                        m.count++;
                    }
                });
            });

            const maxCount = Math.max(...months.map(m => m.count), 1);

            container.innerHTML = months.map(m => {
                const height = (m.count / maxCount) * 180;
                return `
                    <div class="chart-bar" style="height: ${Math.max(height, 4)}px;">
                        <span class="chart-bar-value">${m.count}</span>
                        <span class="chart-bar-label">${m.label}</span>
                    </div>
                `;
            }).join('');
        }

        function renderLevelDonut(pitches) {
            const donut = document.getElementById('levelDonut');
            const legend = document.getElementById('levelLegend');

            const levels = { 1: 0, 2: 0, 3: 0 };
            pitches.forEach(p => {
                const level = getPitchLevel(p);
                levels[level]++;
            });

            const total = pitches.length || 1;
            const l1Pct = (levels[1] / total) * 100;
            const l2Pct = (levels[2] / total) * 100;
            const l3Pct = (levels[3] / total) * 100;

            // Create conic gradient for donut
            const l1End = l1Pct;
            const l2End = l1End + l2Pct;

            donut.style.background = `conic-gradient(
                #22c55e 0% ${l1Pct}%,
                #3b82f6 ${l1Pct}% ${l2End}%,
                #f59e0b ${l2End}% 100%
            )`;

            donut.innerHTML = `
                <div class="donut-center">
                    <div class="donut-center-value">${total}</div>
                    <div class="donut-center-label">Total</div>
                </div>
            `;

            legend.innerHTML = `
                <div class="legend-item">
                    <span class="legend-dot level-1"></span>
                    <span>Level 1: ${levels[1]} (${Math.round(l1Pct)}%)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot level-2"></span>
                    <span>Level 2: ${levels[2]} (${Math.round(l2Pct)}%)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-dot level-3"></span>
                    <span>Level 3: ${levels[3]} (${Math.round(l3Pct)}%)</span>
                </div>
            `;
        }

        function renderTopPitches(pitches) {
            const tbody = document.getElementById('topPitchesTable');
            const noData = document.getElementById('noDataMessage');

            if (pitches.length === 0) {
                tbody.innerHTML = '';
                noData.style.display = 'block';
                return;
            }

            noData.style.display = 'none';

            // Sort by views
            const sorted = [...pitches].sort((a, b) => {
                const viewsA = a.analytics?.views || 0;
                const viewsB = b.analytics?.views || 0;
                return viewsB - viewsA;
            }).slice(0, 10);

            tbody.innerHTML = sorted.map(pitch => {
                const businessName = pitch.businessName || pitch.business_name || 'Untitled';
                const level = getPitchLevel(pitch);
                const industry = pitch.industry || pitch.segment || 'General';
                const views = pitch.analytics?.views || 0;
                const date = formatDate(pitch.createdAt);
                const pitchId = pitch.id || pitch.pitchId;

                return `
                    <tr>
                        <td>
                            <a href="/pitch.html?id=${pitchId}" class="business-name" style="color: #3A6746; text-decoration: none;">
                                ${businessName}
                            </a>
                        </td>
                        <td><span class="level-badge level-${level}">${getLevelLabel(level)}</span></td>
                        <td>${industry}</td>
                        <td><strong>${views}</strong></td>
                        <td>${date}</td>
                    </tr>
                `;
            }).join('');
        }

        async function loadAnalytics(user) {
            const loading = document.getElementById('loading');
            const content = document.getElementById('analyticsContent');

            try {
                const pitchesRef = collection(db, 'pitches');
                const q = query(pitchesRef, where('userId', 'in', [user.uid, 'anonymous']));
                const snapshot = await getDocs(q);

                const pitches = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Calculate metrics
                const totalPitches = pitches.length;
                const totalViews = pitches.reduce((sum, p) => sum + (p.analytics?.views || 0), 0);
                const avgViews = totalPitches > 0 ? Math.round(totalViews / totalPitches * 10) / 10 : 0;

                // This month
                const now = new Date();
                const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                const thisMonthPitches = pitches.filter(p => {
                    const created = p.createdAt?.toDate?.() || null;
                    return created && created >= thisMonthStart;
                }).length;

                // Update summary cards
                document.getElementById('totalPitches').textContent = totalPitches;
                document.getElementById('totalViews').textContent = totalViews;
                document.getElementById('avgViews').textContent = avgViews;
                document.getElementById('thisMonth').textContent = thisMonthPitches;

                // Render charts
                renderMonthlyChart(pitches);
                renderLevelDonut(pitches);
                renderTopPitches(pitches);

                loading.style.display = 'none';
                content.style.display = 'block';

            } catch (error) {
                console.error('Error loading analytics:', error);
                loading.innerHTML = `<p style="color: #d32f2f;">Error loading analytics: ${error.message}</p>`;
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (!user) {
                window.location.href = '/login.html';
                return;
            }
            loadAnalytics(user);
        });
    </script>
</body>
</html>
