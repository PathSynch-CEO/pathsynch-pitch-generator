<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - PathSynch Pitch Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #3A6746 0%, #6B4423 100%);
            color: white;
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 24px; font-weight: 600; }
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .header-actions a, .header-actions button {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        .header-actions a:hover, .header-actions button:hover {
            background: rgba(255,255,255,0.3);
        }
        .header-actions .btn-create {
            background: white;
            color: #3A6746;
        }
        .usage-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.15);
            border-radius: 20px;
            font-size: 13px;
        }
        .usage-badge .usage-bar {
            width: 60px;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            overflow: hidden;
        }
        .usage-badge .usage-bar-fill {
            height: 100%;
            background: #FFC700;
            border-radius: 3px;
            transition: width 0.3s;
        }
        .usage-badge .usage-bar-fill.warning { background: #ff9800; }
        .usage-badge .usage-bar-fill.danger { background: #f44336; }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px;
        }
        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .toolbar h2 {
            color: #3A6746;
            font-size: 28px;
        }
        .toolbar-right {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .sort-select {
            padding: 10px 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        .btn-create-large {
            padding: 12px 24px;
            background: #3A6746;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-create-large:hover { background: #2d5136; }
        
        .pitches-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
        }
        .pitch-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .pitch-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        .pitch-card-header {
            background: linear-gradient(135deg, #3A6746 0%, #4a7a56 100%);
            color: white;
            padding: 20px;
        }
        .pitch-card-header h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }
        .pitch-level-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .pitch-level-badge.level-1 {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .pitch-level-badge.level-2 {
            background: #e3f2fd;
            color: #1565c0;
        }
        .pitch-level-badge.level-3 {
            background: #fff3e0;
            color: #e65100;
        }
        .pitch-card-body {
            padding: 20px;
        }
        .pitch-meta {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #666;
        }
        .pitch-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .pitch-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .pitch-stat {
            text-align: center;
        }
        .pitch-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #3A6746;
        }
        .pitch-stat-label {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        .pitch-industry {
            display: inline-block;
            padding: 6px 12px;
            background: #f0f0f0;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            margin-bottom: 16px;
        }
        .pitch-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .pitch-actions a, .pitch-actions button {
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            text-decoration: none;
            border: none;
        }
        .btn-view {
            background: #3A6746;
            color: white;
        }
        .btn-view:hover { background: #2d5136; }
        .btn-share {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }
        .btn-share:hover { background: #e8e8e8; }
        .btn-delete {
            background: #fff5f5;
            color: #d32f2f;
            border: 1px solid #ffcdd2;
        }
        .btn-delete:hover { background: #ffebee; }
        
        /* Create Another Level buttons */
        .create-level-row {
            display: flex;
            gap: 6px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #eee;
        }
        .btn-create-level {
            flex: 1;
            padding: 8px 4px;
            font-size: 11px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-create-level:hover {
            background: #3A6746;
            color: white;
            border-color: #3A6746;
        }
        .btn-create-level.active {
            background: #e8f5e9;
            border-color: #3A6746;
            color: #3A6746;
            font-weight: 600;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            background: white;
            border-radius: 12px;
        }
        .empty-state h3 {
            color: #333;
            margin-bottom: 12px;
        }
        .empty-state p {
            color: #666;
            margin-bottom: 24px;
        }
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .pitches-grid {
                grid-template-columns: 1fr;
            }
            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            .toolbar-right {
                flex-direction: column;
            }
            .header {
                flex-direction: column;
                gap: 16px;
            }
            .header-actions {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>PathSynch Pitch Generator</h1>
        <div class="header-actions">
            <div class="usage-badge" id="usageBadge">
                <span id="usageText">-/-</span>
                <div class="usage-bar">
                    <div class="usage-bar-fill" id="usageBarFill" style="width:0%"></div>
                </div>
            </div>
            <a href="/bulk-upload.html">Bulk Upload</a>
            <a href="/market-report.html">Market Intel</a>
            <a href="/analytics.html">Analytics</a>
            <a href="/settings.html">Settings</a>
            <a href="/admin/" id="adminLink" style="display:none;">Admin</a>
            <a href="/create-pitch.html" class="btn-create">+ Create New Pitch</a>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="toolbar">
            <h2>Your Pitch Decks</h2>
            <div class="toolbar-right">
                <select class="sort-select" id="sortSelect" onchange="sortPitches()">
                    <option value="newest">Sort: Newest First</option>
                    <option value="oldest">Sort: Oldest First</option>
                    <option value="level-asc">Sort: Level (1‚Üí3)</option>
                    <option value="level-desc">Sort: Level (3‚Üí1)</option>
                    <option value="industry">Sort: Industry</option>
                    <option value="name">Sort: Business Name</option>
                </select>
                <a href="/create-pitch.html" class="btn-create-large">+ Create New Pitch</a>
            </div>
        </div>

        <div id="loading" class="loading">
            <p>Loading your pitches...</p>
        </div>

        <div id="pitchesGrid" class="pitches-grid" style="display:none;"></div>

        <div id="emptyState" class="empty-state" style="display:none;">
            <h3>No Pitches Yet</h3>
            <p>Create your first pitch deck to get started!</p>
            <a href="/create-pitch.html" class="btn-create-large">+ Create New Pitch</a>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, query, where, getDocs, deleteDoc, doc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA8fBm7lu9WK_ImsAdGPthztJ7F07pzDJY",
            authDomain: "pathsynch-pitch-creation.firebaseapp.com",
            projectId: "pathsynch-pitch-creation",
            storageBucket: "pathsynch-pitch-creation.firebasestorage.app",
            messagingSenderId: "796921234100",
            appId: "1:796921234100:web:6e9862fa2194d2c8ae0de1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let allPitches = [];
        let currentUser = null;

        window.logout = async () => {
            await signOut(auth);
            window.location.href = '/login.html';
        };

        window.sortPitches = () => {
            const sortBy = document.getElementById('sortSelect').value;
            let sorted = [...allPitches];

            switch(sortBy) {
                case 'newest':
                    sorted.sort((a, b) => (b.createdAt?.toDate?.() || 0) - (a.createdAt?.toDate?.() || 0));
                    break;
                case 'oldest':
                    sorted.sort((a, b) => (a.createdAt?.toDate?.() || 0) - (b.createdAt?.toDate?.() || 0));
                    break;
                case 'level-asc':
                    sorted.sort((a, b) => getPitchLevel(a) - getPitchLevel(b));
                    break;
                case 'level-desc':
                    sorted.sort((a, b) => getPitchLevel(b) - getPitchLevel(a));
                    break;
                case 'industry':
                    sorted.sort((a, b) => (a.industry || a.segment || '').localeCompare(b.industry || b.segment || ''));
                    break;
                case 'name':
                    sorted.sort((a, b) => (a.businessName || a.business_name || '').localeCompare(b.businessName || b.business_name || ''));
                    break;
            }

            renderPitches(sorted);
        };

        function getPitchLevel(pitch) {
            const level = pitch.pitchLevel || pitch.pitch_level || 3;
            if (typeof level === 'string') {
                if (level.includes('1') || level === 'outreach') return 1;
                if (level.includes('2') || level === 'one-pager') return 2;
                return 3;
            }
            return parseInt(level) || 3;
        }

        function getLevelLabel(pitch) {
            const level = getPitchLevel(pitch);
            switch(level) {
                case 1: return 'Level 1: Outreach';
                case 2: return 'Level 2: One-Pager';
                case 3: return 'Level 3: Enterprise';
                default: return 'Level 3: Enterprise';
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            const now = new Date();
            
            // Compare dates without time
            const dateOnly = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            const todayOnly = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const diffTime = todayOnly - dateOnly;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Store pitch data for create-another feature
        const pitchDataStore = new Map();

        function renderPitches(pitches) {
            const grid = document.getElementById('pitchesGrid');
            
            if (pitches.length === 0) {
                grid.style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';
            grid.style.display = 'grid';

            grid.innerHTML = pitches.map(pitch => {
                const businessName = pitch.businessName || pitch.business_name || 'Untitled Pitch';
                const address = pitch.address || pitch.formData?.address || 'No address';
                const industry = pitch.industry || pitch.segment || pitch.formData?.industry || 'General';
                const subIndustry = pitch.subIndustry || pitch.formData?.subIndustry || '';
                const rating = pitch.googleRating || pitch.google_rank || pitch.formData?.googleRating || 0;
                const reviews = pitch.numReviews || pitch.number_of_google_reviews || pitch.formData?.numReviews || 0;
                
                // Fixed: Get ROI from correct path
                const roi = pitch.roiData?.roi || pitch.roiData?.estimatedROI || pitch.roi || 0;
                
                // Get view count from analytics
                const views = pitch.analytics?.views || 0;
                
                const level = getPitchLevel(pitch);
                const levelLabel = getLevelLabel(pitch);
                const dateStr = formatDate(pitch.createdAt || pitch.created_at);
                const pitchId = pitch.id || pitch.pitchId;
                const shareId = pitch.shareId || pitch.share_id;
                
                // Store pitch data for create-another functionality
                pitchDataStore.set(pitchId, {
                    businessName: businessName,
                    address: address,
                    contactName: pitch.contactName || pitch.formData?.contactName || '',
                    websiteUrl: pitch.websiteUrl || pitch.formData?.websiteUrl || '',
                    googleRating: rating,
                    numReviews: reviews,
                    industry: industry,
                    subIndustry: subIndustry,
                    googleReviews: pitch.formData?.googleReviews || '',
                    monthlyVisits: pitch.formData?.monthlyVisits || '',
                    avgTransaction: pitch.formData?.avgTransaction || ''
                });

                return `
                    <div class="pitch-card" data-id="${pitchId}">
                        <div class="pitch-card-header">
                            <h3>${businessName}</h3>
                            <span class="pitch-level-badge level-${level}">${levelLabel}</span>
                        </div>
                        <div class="pitch-card-body">
                            <div class="pitch-meta">
                                <span class="pitch-meta-item">üìç ${address}</span>
                                <span class="pitch-meta-item">üïê ${dateStr}</span>
                            </div>
                            
                            <div class="pitch-stats">
                                <div class="pitch-stat">
                                    <div class="pitch-stat-value">${rating > 0 ? Number(rating).toFixed(1) : '-'}‚òÖ</div>
                                    <div class="pitch-stat-label">Rating</div>
                                </div>
                                <div class="pitch-stat">
                                    <div class="pitch-stat-value">${reviews > 0 ? reviews : '-'}</div>
                                    <div class="pitch-stat-label">Reviews</div>
                                </div>
                                <div class="pitch-stat">
                                    <div class="pitch-stat-value">${roi > 0 ? roi + '%' : '-'}</div>
                                    <div class="pitch-stat-label">ROI</div>
                                </div>
                                <div class="pitch-stat">
                                    <div class="pitch-stat-value">${views > 0 ? views : '-'}</div>
                                    <div class="pitch-stat-label">Views</div>
                                </div>
                            </div>
                            
                            <div class="pitch-industry">${industry}${subIndustry ? ' ‚Ä¢ ' + subIndustry : ''}</div>
                            
                            <div class="pitch-actions">
                                <a href="/pitch.html?id=${pitchId}" class="btn-view">View</a>
                                <button onclick="sharePitch('${pitchId}', '${shareId}')" class="btn-share">Share</button>
                                <button onclick="deletePitch('${pitchId}')" class="btn-delete">Delete</button>
                            </div>
                            
                            <div class="create-level-row">
                                <button class="btn-create-level ${level === 1 ? 'active' : ''}" 
                                        onclick="createAnotherLevel(1, '${pitchId}')" 
                                        title="Create Level 1 Outreach">
                                    L1 Outreach
                                </button>
                                <button class="btn-create-level ${level === 2 ? 'active' : ''}" 
                                        onclick="createAnotherLevel(2, '${pitchId}')" 
                                        title="Create Level 2 One-Pager">
                                    L2 One-Pager
                                </button>
                                <button class="btn-create-level ${level === 3 ? 'active' : ''}" 
                                        onclick="createAnotherLevel(3, '${pitchId}')" 
                                        title="Create Level 3 Enterprise">
                                    L3 Enterprise
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.createAnotherLevel = (level, pitchId) => {
            const data = pitchDataStore.get(pitchId);
            
            if (!data) {
                alert('Could not find pitch data. Please refresh and try again.');
                return;
            }
            
            // Store in sessionStorage for the create page to pick up
            sessionStorage.setItem('prefillPitch', JSON.stringify({
                ...data,
                pitchLevel: level
            }));
            
            window.location.href = '/create-pitch.html?prefill=true&level=' + level;
        };

        window.sharePitch = async (pitchId, shareId) => {
            try {
                await updateDoc(doc(db, 'pitches', pitchId), { shared: true });
                
                const shareUrl = shareId 
                    ? `${window.location.origin}/pitch.html?share=${shareId}`
                    : `${window.location.origin}/pitch.html?id=${pitchId}`;
                
                await navigator.clipboard.writeText(shareUrl);
                alert('Share link copied to clipboard!\n\n' + shareUrl);
            } catch (error) {
                console.error('Error sharing:', error);
                alert('Failed to share: ' + error.message);
            }
        };

        window.deletePitch = async (pitchId) => {
            if (!confirm('Are you sure you want to delete this pitch?')) return;
            
            try {
                await deleteDoc(doc(db, 'pitches', pitchId));
                allPitches = allPitches.filter(p => (p.id || p.pitchId) !== pitchId);
                sortPitches();
            } catch (error) {
                console.error('Error deleting:', error);
                alert('Failed to delete: ' + error.message);
            }
        };

        async function loadUsage(user) {
            try {
                const now = new Date();
                const period = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const usageId = `${user.uid}_${period}`;
                
                const usageDoc = await getDoc(doc(db, 'usage', usageId));
                
                let used = 0;
                let limit = 5;
                
                if (usageDoc.exists()) {
                    const data = usageDoc.data();
                    used = data.pitchesGenerated || 0;
                    limit = data.limits?.pitches || 5;
                } else {
                    // Fall back to counting this month's pitches
                    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    used = allPitches.filter(p => {
                        const created = p.createdAt?.toDate?.() || new Date(0);
                        return created >= thisMonthStart;
                    }).length;
                }
                
                const usageText = document.getElementById('usageText');
                const usageBarFill = document.getElementById('usageBarFill');
                
                usageText.textContent = limit === -1 ? `${used}/‚àû` : `${used}/${limit}`;
                
                const percent = limit === -1 ? 10 : Math.min((used / limit) * 100, 100);
                usageBarFill.style.width = `${percent}%`;
                usageBarFill.classList.remove('warning', 'danger');
                
                if (limit !== -1) {
                    if (percent >= 90) usageBarFill.classList.add('danger');
                    else if (percent >= 70) usageBarFill.classList.add('warning');
                }
                
            } catch (error) {
                console.log('Could not load usage:', error.message);
                // Fallback: count pitches in the list
                const used = allPitches.length;
                document.getElementById('usageText').textContent = `${used}/5`;
                document.getElementById('usageBarFill').style.width = `${Math.min((used/5)*100, 100)}%`;
            }
        }

        async function loadPitches(user) {
            const loadingDiv = document.getElementById('loading');
            
            try {
                const pitchesRef = collection(db, 'pitches');
                const q = query(pitchesRef, where('userId', 'in', [user.uid, 'anonymous']));
                
                const snapshot = await getDocs(q);
                
                allPitches = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                loadingDiv.style.display = 'none';
                sortPitches();
                
                // Load usage after pitches
                await loadUsage(user);
                
            } catch (error) {
                console.error('Error loading pitches:', error);
                loadingDiv.innerHTML = `<p style="color: #d32f2f;">Error loading pitches: ${error.message}</p>`;
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '/login.html';
                return;
            }
            currentUser = user;
            loadPitches(user);

            // Check if user is admin (by calling admin endpoint)
            try {
                const token = await user.getIdToken();
                const response = await fetch('/api/v1/admin/stats', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    document.getElementById('adminLink').style.display = 'inline-block';
                }
            } catch (e) {
                // Not an admin, that's fine
            }
        });
    </script>
</body>
</html>
