<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Intelligence - PathSynch</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #3A6746 0%, #6B4423 100%);
            color: white;
            padding: 20px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 24px; font-weight: 600; }
        .header-actions {
            display: flex;
            gap: 12px;
        }
        .header-actions a, .header-actions button {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }
        .header-actions a:hover, .header-actions button:hover {
            background: rgba(255,255,255,0.3);
        }
        .container {
            max-width: 1200px;
            margin: 32px auto;
            padding: 0 20px;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .section h2 {
            font-size: 20px;
            color: #3A6746;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e8e8e8;
        }

        /* Generate Form */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 6px;
            color: #333;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3A6746;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background: #3A6746;
            color: white;
        }
        .btn-primary:hover {
            background: #2d5136;
        }
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Usage Info */
        .usage-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #e8f5e9;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .usage-info .usage-text {
            font-size: 14px;
            color: #2e7d32;
        }

        /* Report Display */
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }
        .report-title h3 {
            font-size: 24px;
            color: #333;
            margin-bottom: 8px;
        }
        .report-title p {
            color: #666;
            font-size: 14px;
        }
        .saturation-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .saturation-badge.low {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .saturation-badge.medium {
            background: #fff3e0;
            color: #f57c00;
        }
        .saturation-badge.high {
            background: #ffebee;
            color: #d32f2f;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #3A6746;
        }
        .stat-card .label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
            text-transform: uppercase;
        }

        /* Competitors Table */
        .competitors-table {
            width: 100%;
            border-collapse: collapse;
        }
        .competitors-table th {
            text-align: left;
            padding: 12px;
            background: #f8f9fa;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            border-bottom: 2px solid #e8e8e8;
        }
        .competitors-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .competitors-table tr:hover {
            background: #f9fdf9;
        }
        .rating-stars {
            color: #f59e0b;
        }

        /* Reports List */
        .reports-list {
            margin-top: 20px;
        }
        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .report-item:hover {
            background: #e8f5e9;
        }
        .report-item-info h4 {
            font-size: 16px;
            color: #333;
            margin-bottom: 4px;
        }
        .report-item-info p {
            font-size: 13px;
            color: #666;
        }
        .report-item-meta {
            text-align: right;
        }
        .report-item-meta .date {
            font-size: 12px;
            color: #888;
        }

        /* Saved Searches */
        .saved-search-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, #fff9e6 0%, #fff5d6 100%);
            border: 1px solid #f59e0b33;
            border-radius: 8px;
            transition: all 0.2s;
        }
        .saved-search-item:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .saved-search-info h4 {
            font-size: 15px;
            color: #333;
            margin-bottom: 4px;
        }
        .saved-search-info p {
            font-size: 12px;
            color: #666;
        }
        .saved-search-actions {
            display: flex;
            gap: 8px;
        }
        .saved-search-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .saved-search-actions .run-btn {
            background: #3A6746;
            color: white;
        }
        .saved-search-actions .run-btn:hover {
            background: #2d5136;
        }
        .saved-search-actions .delete-btn {
            background: #fee2e2;
            color: #dc2626;
        }
        .saved-search-actions .delete-btn:hover {
            background: #fecaca;
        }
        .no-saved-searches {
            text-align: center;
            padding: 24px;
            color: #888;
            font-size: 14px;
        }

        /* Loading & Messages */
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        .alert.visible {
            display: block;
        }
        .alert.success {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .alert.error {
            background: #ffebee;
            color: #c62828;
        }

        /* Feature Gate */
        .feature-gate {
            text-align: center;
            padding: 48px;
        }
        .feature-gate h3 {
            color: #333;
            margin-bottom: 12px;
        }
        .feature-gate p {
            color: #666;
            margin-bottom: 24px;
        }

        /* Opportunity Score */
        .opportunity-card {
            background: linear-gradient(135deg, #3A6746 0%, #2d5136 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            margin-bottom: 24px;
        }
        .opportunity-card h3 {
            font-size: 14px;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        .opportunity-score {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .opportunity-level {
            font-size: 18px;
            margin-bottom: 16px;
        }
        .opportunity-bar {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
        }
        .opportunity-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.5s ease;
        }
        .opportunity-factors {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        .factor-chip {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            border-bottom: 2px solid #e8e8e8;
        }
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab:hover {
            color: #3A6746;
        }
        .tab.active {
            color: #3A6746;
            border-bottom-color: #3A6746;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Map */
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 24px;
        }
        #competitorMap {
            height: 100%;
            width: 100%;
        }

        /* Charts */
        .chart-container {
            height: 300px;
            position: relative;
            margin-bottom: 24px;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }
        .chart-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }
        .chart-card h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
            text-transform: uppercase;
        }

        /* Recommendations */
        .recommendations-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }
        .recommendations-section h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 16px;
        }
        .target-customer {
            background: white;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 16px;
        }
        .target-customer h4 {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .differentiator-list, .risk-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .differentiator-item, .risk-item {
            background: white;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .differentiator-item {
            border-left-color: #3A6746;
        }
        .risk-item.high {
            border-left-color: #d32f2f;
        }
        .risk-item.medium {
            border-left-color: #f57c00;
        }
        .risk-item.low {
            border-left-color: #2e7d32;
        }
        .differentiator-item h5, .risk-item h5 {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }
        .differentiator-item p, .risk-item p {
            font-size: 13px;
            color: #666;
        }

        /* Upgrade Banner */
        .upgrade-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .upgrade-banner h4 {
            font-size: 16px;
            margin-bottom: 4px;
        }
        .upgrade-banner p {
            font-size: 13px;
            opacity: 0.9;
        }
        .upgrade-banner .btn {
            background: white;
            color: #667eea;
        }

        /* PDF Button */
        .pdf-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #3A6746;
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        .pdf-button:hover {
            background: #2d5136;
        }

        /* Seasonality Card */
        .seasonality-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            margin-bottom: 24px;
        }
        .seasonality-card h3 {
            font-size: 14px;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: 12px;
        }
        .seasonality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }
        .seasonality-item {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }
        .seasonality-item .value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .seasonality-item .label {
            font-size: 11px;
            text-transform: uppercase;
            opacity: 0.85;
        }
        .peak-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #f59e0b;
            color: #1a1a1a;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 16px;
        }
        .off-peak-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 16px;
        }
        .seasonality-recommendation {
            margin-top: 16px;
            padding: 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            font-size: 13px;
        }

        /* Pitch Integration Button */
        .pitch-integration-btn {
            background: linear-gradient(135deg, #3A6746 0%, #6B4423 100%);
            color: white;
            padding: 16px 32px;
            border-radius: 10px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 24px auto;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .pitch-integration-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        .pitch-integration-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        /* Action buttons row */
        .action-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 380px;
        }
        .toast {
            padding: 14px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            font-size: 14px;
        }
        .toast.success {
            background: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        .toast.error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        .toast.info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #1565c0;
        }
        .toast.warning {
            background: #fff3e0;
            color: #e65100;
            border-left: 4px solid #e65100;
        }
        .toast-icon {
            font-size: 18px;
            flex-shrink: 0;
        }
        .toast-message {
            flex: 1;
        }
        .toast-close {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            opacity: 0.6;
            padding: 0;
            line-height: 1;
        }
        .toast-close:hover {
            opacity: 1;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        .toast.hiding {
            animation: slideOut 0.3s ease forwards;
        }

        /* Chart Loading States */
        .chart-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            min-height: 200px;
            color: #888;
        }
        .chart-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e8e8e8;
            border-top-color: #3A6746;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .chart-loading-text {
            font-size: 13px;
        }

        /* Sub-industry dropdown */
        .subindustry-group {
            display: none;
        }
        .subindustry-group.visible {
            display: block;
        }

        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 12px; }
            .report-header { flex-direction: column; gap: 12px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .tabs { overflow-x: auto; }
            .upgrade-banner { flex-direction: column; gap: 12px; text-align: center; }
        }
    </style>
<!-- PostHog Analytics -->
<script src="/js/posthog.js"></script>
</head>
<body>
    <div class="header">
        <h1>Market Intelligence</h1>
        <div class="header-actions">
            <a href="/dashboard.html">Dashboard</a>
            <a href="/create-pitch.html">Create Pitch</a>
            <button onclick="logout()">Logout</button>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <div id="alertSuccess" class="alert success"></div>
        <div id="alertError" class="alert error"></div>

        <!-- Feature Gate -->
        <div class="section" id="featureGate" style="display: none;">
            <div class="feature-gate">
                <h3>Market Intelligence Not Available</h3>
                <p>Upgrade to Growth or Scale plan to unlock market intelligence reports with competitor analysis and demographic data.</p>
                <a href="/pricing.html" class="btn btn-primary">View Plans</a>
            </div>
        </div>

        <!-- Generate Report Section -->
        <div class="section" id="generateSection">
            <h2>Generate Market Report</h2>

            <div class="usage-info">
                <span class="usage-text" id="usageText">Loading usage...</span>
                <a href="/pricing.html" style="font-size: 13px; color: #3A6746;">Upgrade for more</a>
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="city">City</label>
                    <input type="text" id="city" placeholder="Austin">
                </div>
                <div class="form-group">
                    <label for="state">State</label>
                    <select id="state">
                        <option value="">Select State</option>
                        <option value="Alabama">Alabama</option>
                        <option value="Alaska">Alaska</option>
                        <option value="Arizona">Arizona</option>
                        <option value="Arkansas">Arkansas</option>
                        <option value="California">California</option>
                        <option value="Colorado">Colorado</option>
                        <option value="Connecticut">Connecticut</option>
                        <option value="Delaware">Delaware</option>
                        <option value="Florida">Florida</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Hawaii">Hawaii</option>
                        <option value="Idaho">Idaho</option>
                        <option value="Illinois">Illinois</option>
                        <option value="Indiana">Indiana</option>
                        <option value="Iowa">Iowa</option>
                        <option value="Kansas">Kansas</option>
                        <option value="Kentucky">Kentucky</option>
                        <option value="Louisiana">Louisiana</option>
                        <option value="Maine">Maine</option>
                        <option value="Maryland">Maryland</option>
                        <option value="Massachusetts">Massachusetts</option>
                        <option value="Michigan">Michigan</option>
                        <option value="Minnesota">Minnesota</option>
                        <option value="Mississippi">Mississippi</option>
                        <option value="Missouri">Missouri</option>
                        <option value="Montana">Montana</option>
                        <option value="Nebraska">Nebraska</option>
                        <option value="Nevada">Nevada</option>
                        <option value="New Hampshire">New Hampshire</option>
                        <option value="New Jersey">New Jersey</option>
                        <option value="New Mexico">New Mexico</option>
                        <option value="New York">New York</option>
                        <option value="North Carolina">North Carolina</option>
                        <option value="North Dakota">North Dakota</option>
                        <option value="Ohio">Ohio</option>
                        <option value="Oklahoma">Oklahoma</option>
                        <option value="Oregon">Oregon</option>
                        <option value="Pennsylvania">Pennsylvania</option>
                        <option value="Rhode Island">Rhode Island</option>
                        <option value="South Carolina">South Carolina</option>
                        <option value="South Dakota">South Dakota</option>
                        <option value="Tennessee">Tennessee</option>
                        <option value="Texas">Texas</option>
                        <option value="Utah">Utah</option>
                        <option value="Vermont">Vermont</option>
                        <option value="Virginia">Virginia</option>
                        <option value="Washington">Washington</option>
                        <option value="West Virginia">West Virginia</option>
                        <option value="Wisconsin">Wisconsin</option>
                        <option value="Wyoming">Wyoming</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="industry">Industry</label>
                    <select id="industry" required onchange="updateSubIndustries()">
                        <option value="">Select Industry</option>
                        <option value="Food & Beverage">Food & Beverage</option>
                        <option value="Automotive">Automotive</option>
                        <option value="Health & Wellness">Health & Wellness</option>
                        <option value="Home Services">Home Services</option>
                        <option value="Professional Services">Professional Services</option>
                        <option value="Retail">Retail</option>
                        <option value="Salon & Beauty">Salon / Beauty</option>
                    </select>
                </div>
                <div class="form-group subindustry-group" id="subIndustryGroup">
                    <label for="subIndustry">Sub-Industry</label>
                    <select id="subIndustry">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="companySize">Company Size</label>
                    <select id="companySize">
                        <option value="small">Small (1-10 employees)</option>
                        <option value="medium">Medium (11-50 employees)</option>
                        <option value="large">Large (51-500 employees)</option>
                        <option value="national">National (500+ employees)</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-primary" id="generateBtn" onclick="generateReport()">
                Generate Report
            </button>
        </div>

        <!-- Report Display Section -->
        <div class="section" id="reportSection" style="display: none;">
            <div class="report-header">
                <div class="report-title">
                    <h3 id="reportLocation">-</h3>
                    <p id="reportIndustry">-</p>
                </div>
                <span class="saturation-badge" id="saturationBadge">-</span>
            </div>

            <!-- Upgrade Banner (Starter tier only) -->
            <div class="upgrade-banner" id="upgradeBanner" style="display: none;">
                <div>
                    <h4>Unlock Full Market Intelligence</h4>
                    <p>Get opportunity scores, demographic breakdowns, trends, and AI recommendations</p>
                </div>
                <a href="/pricing.html" class="btn">Upgrade to Growth</a>
            </div>

            <!-- Opportunity Score (Growth+ tier) -->
            <div class="opportunity-card" id="opportunityCard" style="display: none;">
                <h3>Opportunity Score</h3>
                <div class="opportunity-score" id="opportunityScore">-</div>
                <div class="opportunity-level" id="opportunityLevel">-</div>
                <div class="opportunity-bar">
                    <div class="opportunity-fill" id="opportunityFill" style="width: 0%"></div>
                </div>
                <div class="opportunity-factors" id="opportunityFactors"></div>
            </div>

            <!-- Seasonality Card (all tiers) -->
            <div class="seasonality-card" id="seasonalityCard" style="display: none;">
                <h3>ðŸ“… Seasonality & Timing</h3>
                <div class="seasonality-grid">
                    <div class="seasonality-item">
                        <div class="value" id="seasonalityPattern">-</div>
                        <div class="label">Pattern</div>
                    </div>
                    <div class="seasonality-item">
                        <div class="value" id="seasonalityImpact">-</div>
                        <div class="label">Seasonal Impact</div>
                    </div>
                    <div class="seasonality-item">
                        <div class="value" id="seasonalityMomentum">-</div>
                        <div class="label">Demand Momentum</div>
                    </div>
                    <div class="seasonality-item">
                        <div class="value" id="seasonalityTrend">-</div>
                        <div class="label">YoY Trend</div>
                    </div>
                </div>
                <div id="seasonalityBadge"></div>
                <div class="seasonality-recommendation" id="seasonalityRecommendation" style="display: none;"></div>
            </div>

            <!-- Pitch Integration Button (Scale tier only) -->
            <div class="action-buttons" id="pitchIntegrationSection" style="display: none;">
                <button class="pitch-integration-btn" id="generatePitchBtn" onclick="generatePitchFromMarket()">
                    ðŸ“Š Generate Pitch from Market Data
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="value" id="statCompetitors">-</div>
                    <div class="label">Competitors</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statMarketSize">-</div>
                    <div class="label">Market Size</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statPopulation">-</div>
                    <div class="label">Population</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statIncome">-</div>
                    <div class="label">Median Income</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="statGrowth">-</div>
                    <div class="label">Growth Rate</div>
                </div>
            </div>

            <!-- Tab Navigation (Growth+ tier) -->
            <div class="tabs" id="reportTabs" style="display: none;">
                <button class="tab active" onclick="showTab('overview')">Overview</button>
                <button class="tab" onclick="showTab('map')">Map</button>
                <button class="tab" onclick="showTab('demographics')">Demographics</button>
                <button class="tab" onclick="showTab('trends')">Trends</button>
            </div>

            <!-- Overview Tab -->
            <div class="tab-content active" id="tab-overview">
                <h3 style="font-size: 18px; color: #333; margin-bottom: 16px;">Top Competitors (Click to Create Lead)</h3>
                <table class="competitors-table">
                    <thead>
                        <tr>
                            <th>Business Name</th>
                            <th>Address</th>
                            <th>Rating</th>
                            <th>Reviews</th>
                            <th style="width: 100px;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="competitorsBody">
                    </tbody>
                </table>

                <!-- Saturation Chart -->
                <div class="chart-card" style="margin-top: 24px;">
                    <h4>Market Saturation Breakdown</h4>
                    <div class="chart-container" style="height: 250px;">
                        <div class="chart-loading" id="saturationChartLoading">
                            <div class="chart-spinner"></div>
                            <div class="chart-loading-text">Loading chart...</div>
                        </div>
                        <canvas id="saturationChart" style="display: none;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Map Tab -->
            <div class="tab-content" id="tab-map">
                <div class="map-container">
                    <div id="competitorMap"></div>
                </div>
            </div>

            <!-- Demographics Tab -->
            <div class="tab-content" id="tab-demographics">
                <div class="charts-grid">
                    <div class="chart-card">
                        <h4>Age Distribution</h4>
                        <div class="chart-container">
                            <div class="chart-loading" id="ageChartLoading">
                                <div class="chart-spinner"></div>
                                <div class="chart-loading-text">Loading chart...</div>
                            </div>
                            <canvas id="ageChart" style="display: none;"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h4>Income Distribution</h4>
                        <div class="chart-container">
                            <div class="chart-loading" id="incomeChartLoading">
                                <div class="chart-spinner"></div>
                                <div class="chart-loading-text">Loading chart...</div>
                            </div>
                            <canvas id="incomeChart" style="display: none;"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h4>Education Level</h4>
                        <div class="chart-container">
                            <div class="chart-loading" id="educationChartLoading">
                                <div class="chart-spinner"></div>
                                <div class="chart-loading-text">Loading chart...</div>
                            </div>
                            <canvas id="educationChart" style="display: none;"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h4>Commute Patterns</h4>
                        <div class="chart-container">
                            <div class="chart-loading" id="commuteChartLoading">
                                <div class="chart-spinner"></div>
                                <div class="chart-loading-text">Loading chart...</div>
                            </div>
                            <canvas id="commuteChart" style="display: none;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trends Tab -->
            <div class="tab-content" id="tab-trends">
                <div class="charts-grid">
                    <div class="chart-card">
                        <h4>Business Trend</h4>
                        <div id="trendInfo" style="padding: 20px; text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: #3A6746;" id="trendLabel">-</div>
                            <div style="font-size: 14px; color: #666; margin-top: 8px;" id="trendDescription">-</div>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h4>5-Year Growth Projection</h4>
                        <div id="projectionInfo" style="padding: 20px; text-align: center;">
                            <div style="font-size: 36px; font-weight: 700; color: #3A6746;" id="projectionValue">-</div>
                            <div style="font-size: 14px; color: #666; margin-top: 8px;">Projected market growth</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sales Intelligence Section -->
            <div class="recommendations-section" id="salesIntelligenceSection" style="display: none;">
                <h3>Sales Intelligence</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Industry-specific insights to guide your outreach strategy</p>

                <div style="display: grid; gap: 20px;">
                    <!-- Decision Makers -->
                    <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #3A6746;">
                        <h4 style="font-size: 14px; color: #3A6746; margin: 0 0 8px; display: flex; align-items: center; gap: 8px;">
                            <span>Decision Makers</span>
                        </h4>
                        <p style="font-size: 12px; color: #888; margin: 0 0 12px;">Key roles who approve or champion solutions in this segment</p>
                        <div id="decisionMakersList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>

                    <!-- Key Pain Points -->
                    <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <h4 style="font-size: 14px; color: #dc2626; margin: 0 0 8px;">Key Pain Points</h4>
                        <p style="font-size: 12px; color: #888; margin: 0 0 12px;">Common frustrations that make this segment care about solutions</p>
                        <ul id="painPointsList" style="margin: 0; padding-left: 20px; color: #333; font-size: 14px; line-height: 1.8;"></ul>
                    </div>

                    <!-- Primary KPIs -->
                    <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #2563eb;">
                        <h4 style="font-size: 14px; color: #2563eb; margin: 0 0 8px;">Primary KPIs</h4>
                        <p style="font-size: 12px; color: #888; margin: 0 0 12px;">Metrics this segment watches to judge success</p>
                        <div id="kpisList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>

                    <!-- Top Channels -->
                    <div style="background: white; padding: 16px; border-radius: 8px; border-left: 4px solid #7c3aed;">
                        <h4 style="font-size: 14px; color: #7c3aed; margin: 0 0 8px;">Top Marketing Channels</h4>
                        <p style="font-size: 12px; color: #888; margin: 0 0 12px;">Channels that matter most for this segment</p>
                        <div id="channelsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                </div>
            </div>

            <!-- Recommendations Section (Growth+ tier) -->
            <div class="recommendations-section" id="recommendationsSection" style="display: none;">
                <h3>Market Recommendations</h3>
                <div class="target-customer">
                    <h4>Target Customer</h4>
                    <p id="targetCustomer" style="font-size: 16px; color: #333;">-</p>
                </div>

                <h4 style="font-size: 14px; color: #666; margin: 16px 0 12px; text-transform: uppercase;">Differentiators</h4>
                <div class="differentiator-list" id="differentiatorList"></div>

                <h4 style="font-size: 14px; color: #666; margin: 24px 0 12px; text-transform: uppercase;">Key Risks</h4>
                <div class="risk-list" id="riskList"></div>
            </div>
        </div>

        <!-- PDF Download and Email Buttons (Scale tier) -->
        <div class="pdf-actions" id="pdfActions" style="display: none; gap: 12px; justify-content: center; flex-wrap: wrap; margin-top: 24px;">
            <button class="pdf-button" id="pdfButton" onclick="downloadPDF()">
                Download PDF Report
            </button>
            <button class="pdf-button" id="emailButton" onclick="emailReport()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                Email Report
            </button>
            <button class="pdf-button" id="saveSearchButton" onclick="saveCurrentSearch()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                Save Search
            </button>
        </div>

        <!-- Saved Searches -->
        <div class="section" id="savedSearchesSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <h2>Saved Searches</h2>
                <span class="search-count" id="savedSearchCount" style="color: #888; font-size: 14px;"></span>
            </div>
            <div class="saved-searches-list" id="savedSearchesList" style="display: grid; gap: 12px;">
                <div class="loading">Loading saved searches...</div>
            </div>
        </div>

        <!-- Previous Reports -->
        <div class="section">
            <h2>Previous Reports</h2>
            <div class="reports-list" id="reportsList">
                <div class="loading">Loading reports...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyA8fBm7lu9WK_ImsAdGPthztJ7F07pzDJY",
            authDomain: "pathsynch-pitch-creation.firebaseapp.com",
            projectId: "pathsynch-pitch-creation",
            storageBucket: "pathsynch-pitch-creation.firebasestorage.app",
            messagingSenderId: "796921234100",
            appId: "1:796921234100:web:6e9862fa2194d2c8ae0de1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const API_BASE = 'https://us-central1-pathsynch-pitch-creation.cloudfunctions.net/api/v1';

        let currentUser = null;
        let idToken = null;
        let reportsLimit = 0;
        let reportsUsed = 0;
        let currentTier = 'starter';
        let competitorMap = null;
        let charts = {};
        let userRole = 'owner'; // Default to owner (solo users can always delete)

        // Sub-industry options by industry
        const subIndustries = {
            'Food & Beverage': [
                { value: 'Full Service Restaurant', label: 'Full Service Restaurant' },
                { value: 'Fast Casual', label: 'Fast Casual / Quick Service' },
                { value: 'Coffee & Cafe', label: 'Coffee Shop / Cafe' },
                { value: 'Bar & Nightlife', label: 'Bar / Nightclub' }
            ],
            'Automotive': [
                { value: 'Auto Repair', label: 'Auto Repair' },
                { value: 'Body Shop', label: 'Body Shop' },
                { value: 'Car Dealership', label: 'Car Dealership' }
            ],
            'Health & Wellness': [
                { value: 'Gym & Fitness', label: 'Gym / Fitness Center' },
                { value: 'Medical Practice', label: 'Medical Practice' },
                { value: 'Dental Practice', label: 'Dental Practice' },
                { value: 'Chiropractic', label: 'Chiropractic' },
                { value: 'Spa & Massage', label: 'Spa / Massage' }
            ],
            'Home Services': [
                { value: 'Plumbing & HVAC', label: 'Plumbing / HVAC' },
                { value: 'Electrical', label: 'Electrical' },
                { value: 'Roofing', label: 'Roofing Contractor' },
                { value: 'Residential Roofing', label: 'Residential Roofing' },
                { value: 'Commercial Roofing', label: 'Commercial Roofing' },
                { value: 'Landscaping', label: 'Landscaping / Lawn Care' },
                { value: 'General Contractor', label: 'General Contractor' },
                { value: 'Painting', label: 'Painting Contractor' },
                { value: 'Flooring', label: 'Flooring / Carpet' },
                { value: 'Windows & Doors', label: 'Windows & Doors' },
                { value: 'Pest Control', label: 'Pest Control' },
                { value: 'Cleaning Services', label: 'Cleaning Services' }
            ],
            'Professional Services': [
                { value: 'Legal', label: 'Legal / Law Firm' },
                { value: 'Accounting', label: 'Accounting / CPA' },
                { value: 'Real Estate', label: 'Real Estate' },
                { value: 'Insurance', label: 'Insurance' }
            ],
            'Retail': [
                { value: 'General Merchandise', label: 'General Merchandise' },
                { value: 'Clothing', label: 'Clothing / Apparel' },
                { value: 'Electronics', label: 'Electronics' }
            ],
            'Salon & Beauty': [
                { value: 'Hair Salon', label: 'Hair Salon / Barber' },
                { value: 'Beauty Salon', label: 'Beauty Salon' },
                { value: 'Nail Salon', label: 'Nail Salon' }
            ]
        };

        // Custom sub-industries loaded from user's saved reports
        let customSubIndustries = {};

        // Saved searches loaded for dropdown population
        let savedSearches = [];

        // Load user's custom sub-industries from their market reports
        async function loadCustomSubIndustries() {
            if (!idToken) return;

            try {
                const response = await fetch(`${API_BASE}/market/custom-sub-industries`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    customSubIndustries = result.data || {};
                    console.log('Loaded custom sub-industries:', customSubIndustries);
                }
            } catch (error) {
                console.error('Error loading custom sub-industries:', error);
            }
        }

        window.updateSubIndustries = () => {
            const industry = document.getElementById('industry').value;
            const subGroup = document.getElementById('subIndustryGroup');
            const subSelect = document.getElementById('subIndustry');

            // Get built-in sub-industries for this industry
            const builtIn = subIndustries[industry] || [];

            // Get custom sub-industries for this industry
            const custom = customSubIndustries[industry] || [];

            // Merge and dedupe (custom ones appear first with "Custom:" prefix if not already built-in)
            const builtInValues = new Set(builtIn.map(s => s.value.toLowerCase()));
            const uniqueCustom = custom.filter(c => !builtInValues.has(c.value.toLowerCase()));

            const allOptions = [...builtIn];

            // Add custom options with a separator if there are any
            if (uniqueCustom.length > 0) {
                allOptions.push({ value: '', label: 'â”€â”€ Your Custom Types â”€â”€', disabled: true });
                uniqueCustom.forEach(c => {
                    allOptions.push({ value: c.value, label: c.label });
                });
            }

            if (allOptions.length > 0) {
                subSelect.innerHTML = '<option value="">All Types</option>' +
                    allOptions.map(s =>
                        s.disabled
                            ? `<option value="" disabled>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</option>`
                            : `<option value="${s.value}">${s.label}</option>`
                    ).join('');
                subGroup.classList.add('visible');
            } else {
                subGroup.classList.remove('visible');
            }
        };

        window.showTab = (tabName) => {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.tab[onclick="showTab('${tabName}')"]`).classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');

            // Initialize map if switching to map tab
            if (tabName === 'map' && !competitorMap) {
                initializeMap();
            }
        };

        window.logout = async () => {
            await signOut(auth);
            window.location.href = '/login.html';
        };

        // Toast notification system
        function showToast(type, message, duration = 5000) {
            const container = document.getElementById('toastContainer');
            const icons = {
                success: 'âœ“',
                error: 'âœ•',
                info: 'â„¹',
                warning: 'âš '
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${message}</span>
                <button class="toast-close" onclick="this.parentElement.remove()">Ã—</button>
            `;

            container.appendChild(toast);

            // Auto-remove after duration
            setTimeout(() => {
                toast.classList.add('hiding');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Legacy alert function (now uses toast)
        function showAlert(type, message) {
            showToast(type, message);
        }

        function formatCurrency(value) {
            if (value >= 1000000) {
                return '$' + (value / 1000000).toFixed(1) + 'M';
            } else if (value >= 1000) {
                return '$' + (value / 1000).toFixed(0) + 'K';
            }
            return '$' + value.toLocaleString();
        }

        function formatNumber(value) {
            if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(0) + 'K';
            }
            return value.toLocaleString();
        }

        async function loadSubscription() {
            try {
                const response = await fetch(`${API_BASE}/subscription`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();

                if (result.success && result.data) {
                    const limits = result.data.planDetails?.limits || {};
                    reportsLimit = limits.marketReportsPerMonth || 0;
                    reportsUsed = result.data.usage?.marketReportsThisMonth || 0;

                    if (reportsLimit <= 0) {
                        document.getElementById('generateSection').style.display = 'none';
                        document.getElementById('featureGate').style.display = 'block';
                    } else {
                        document.getElementById('usageText').textContent =
                            `${reportsUsed} / ${reportsLimit} reports used this month`;
                    }
                }
            } catch (error) {
                console.error('Error loading subscription:', error);
            }
        }

        window.generateReport = async () => {
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value;
            const industry = document.getElementById('industry').value;
            const subIndustry = document.getElementById('subIndustry').value;
            const companySize = document.getElementById('companySize').value;

            if (!industry) {
                showAlert('error', 'Please select an industry');
                return;
            }

            if (!city && !state) {
                showAlert('error', 'Please enter a city or select a state');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            try {
                const response = await fetch(`${API_BASE}/market/report`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({ city, state, industry, subIndustry, companySize })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message || result.error);
                }

                currentTier = result.tier || 'starter';
                displayReport(result);
                await loadReports();

                // Update usage
                reportsUsed++;
                document.getElementById('usageText').textContent =
                    `${reportsUsed} / ${reportsLimit} reports used this month`;

                showAlert('success', 'Report generated successfully!');

            } catch (error) {
                console.error('Error generating report:', error);
                showAlert('error', error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Report';
            }
        };

        function displayReport(result) {
            const data = result.data;
            const location = result.location;
            const tier = result.tier || 'starter';
            currentTier = tier;

            document.getElementById('reportSection').style.display = 'block';

            // Location and industry
            const industryDisplay = typeof result.industry === 'object'
                ? result.industry.display || result.industry.naicsTitle
                : result.industry;
            document.getElementById('reportLocation').textContent =
                [location.city, location.state].filter(Boolean).join(', ') || 'Unknown Location';
            document.getElementById('reportIndustry').textContent = industryDisplay;

            // Saturation badge
            const saturationBadge = document.getElementById('saturationBadge');
            saturationBadge.textContent = (data.saturation || 'medium').toUpperCase() + ' Competition';
            saturationBadge.className = 'saturation-badge ' + (data.saturation || 'medium');

            // Stats
            document.getElementById('statCompetitors').textContent = data.competitorCount || 0;
            document.getElementById('statMarketSize').textContent = data.marketSize ? formatCurrency(data.marketSize) : '-';
            document.getElementById('statPopulation').textContent = data.demographics?.population ? formatNumber(data.demographics.population) : '-';
            document.getElementById('statIncome').textContent = data.demographics?.medianIncome ? formatCurrency(data.demographics.medianIncome) : '-';
            document.getElementById('statGrowth').textContent = data.growthRate ? data.growthRate + '%' : '-';

            // Competitors table with lead creation
            const tbody = document.getElementById('competitorsBody');
            tbody.innerHTML = (data.competitors || []).map((comp, idx) => `
                <tr>
                    <td><strong>${comp.name}</strong></td>
                    <td>${comp.address || '-'}</td>
                    <td class="rating-stars">${comp.rating ? comp.rating.toFixed(1) + ' â˜…' : '-'}</td>
                    <td>${comp.reviews || 0}</td>
                    <td>
                        <button class="create-lead-btn" onclick="createLeadFromCompetitor(${idx})"
                                style="padding: 6px 12px; background: #4F46E5; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            Create Pitch
                        </button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" style="text-align:center;color:#888;">No competitors found</td></tr>';

            // Display seasonality data (all tiers)
            displaySeasonality(data, result.companySize);

            // Store current report data for pitch integration
            window.currentReportData = {
                location: location,
                industry: result.industry,
                companySize: result.companySize,
                salesIntelligence: result.salesIntelligence,
                data: data,
                reportId: result.reportId
            };

            // Show/hide tier-specific elements
            if (tier === 'starter') {
                document.getElementById('upgradeBanner').style.display = 'flex';
                document.getElementById('opportunityCard').style.display = 'none';
                document.getElementById('reportTabs').style.display = 'none';
                document.getElementById('salesIntelligenceSection').style.display = 'none';
                document.getElementById('recommendationsSection').style.display = 'none';
                document.getElementById('pdfActions').style.display = 'none';
                document.getElementById('pitchIntegrationSection').style.display = 'none';
            } else {
                document.getElementById('upgradeBanner').style.display = 'none';
                document.getElementById('reportTabs').style.display = 'flex';

                // Opportunity Score
                if (data.opportunityScore !== undefined) {
                    document.getElementById('opportunityCard').style.display = 'block';
                    document.getElementById('opportunityScore').textContent = data.opportunityScore;
                    document.getElementById('opportunityLevel').textContent = data.opportunityLevel === 'high'
                        ? 'High Opportunity Market'
                        : data.opportunityLevel === 'medium'
                        ? 'Moderate Opportunity'
                        : data.opportunityLevel === 'low'
                        ? 'Limited Opportunity'
                        : 'Challenging Market';
                    document.getElementById('opportunityFill').style.width = data.opportunityScore + '%';

                    // Top factors
                    if (data.opportunityFactors) {
                        document.getElementById('opportunityFactors').innerHTML =
                            data.opportunityFactors.slice(0, 3).map(f =>
                                `<span class="factor-chip">${f.name}: ${f.score}/100</span>`
                            ).join('');
                    }
                }

                // Sales Intelligence (all tiers)
                if (result.salesIntelligence) {
                    const intel = result.salesIntelligence;
                    document.getElementById('salesIntelligenceSection').style.display = 'block';

                    // Decision Makers
                    document.getElementById('decisionMakersList').innerHTML =
                        (intel.decisionMakers || []).map(dm =>
                            `<span style="background: #e8f5e9; color: #2e7d32; padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 500;">${dm}</span>`
                        ).join('');

                    // Pain Points
                    document.getElementById('painPointsList').innerHTML =
                        (intel.painPoints || []).map(pp =>
                            `<li style="margin-bottom: 8px;">${pp}</li>`
                        ).join('');

                    // KPIs
                    document.getElementById('kpisList').innerHTML =
                        (intel.primaryKPIs || []).map(kpi =>
                            `<span style="background: #e3f2fd; color: #1565c0; padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 500;">${kpi}</span>`
                        ).join('');

                    // Channels
                    document.getElementById('channelsList').innerHTML =
                        (intel.topChannels || []).map(ch =>
                            `<span style="background: #f3e8ff; color: #7c3aed; padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 500;">${ch}</span>`
                        ).join('');
                }

                // Recommendations
                if (data.recommendations) {
                    document.getElementById('recommendationsSection').style.display = 'block';
                    document.getElementById('targetCustomer').textContent = data.recommendations.targetCustomer;

                    document.getElementById('differentiatorList').innerHTML =
                        (data.recommendations.differentiators || []).map(d => `
                            <div class="differentiator-item">
                                <h5>${d.title}</h5>
                                <p>${d.description}</p>
                            </div>
                        `).join('') || '<p style="color: #888;">No specific differentiators identified</p>';

                    document.getElementById('riskList').innerHTML =
                        (data.recommendations.risks || []).map(r => `
                            <div class="risk-item ${r.level}">
                                <h5>${r.title}</h5>
                                <p>${r.description}</p>
                            </div>
                        `).join('') || '<p style="color: #888;">No significant risks identified</p>';
                }

                // Trends
                if (data.establishmentTrend) {
                    document.getElementById('trendLabel').textContent = data.establishmentTrend;
                    document.getElementById('trendDescription').textContent =
                        data.fiveYearProjection ? `Based on ${data.growthRate}% annual growth` : '';
                }
                if (data.fiveYearProjection) {
                    document.getElementById('projectionValue').textContent =
                        (data.fiveYearProjection > 0 ? '+' : '') + data.fiveYearProjection + '%';
                }

                // Render charts
                renderSaturationChart(data.saturationComponents);
                if (data.ageDistribution) renderAgeChart(data.ageDistribution);
                if (data.educationProfile) renderEducationChart(data.educationProfile);
                if (data.commutePatterns) renderCommuteChart(data.commutePatterns);

                // PDF/Email buttons and Pitch Integration (Scale only)
                if (tier === 'scale') {
                    document.getElementById('pdfActions').style.display = 'flex';
                    document.getElementById('pitchIntegrationSection').style.display = 'flex';
                } else {
                    document.getElementById('pdfActions').style.display = 'none';
                    document.getElementById('pitchIntegrationSection').style.display = 'none';
                }

                // Store coordinates for map
                window.reportCompetitors = data.competitors;
                window.reportCenter = location.coordinates;
            }

            // Scroll to report
            document.getElementById('reportSection').scrollIntoView({ behavior: 'smooth' });
        }

        function renderSaturationChart(components) {
            const loadingEl = document.getElementById('saturationChartLoading');
            const canvasEl = document.getElementById('saturationChart');

            if (!components) {
                if (loadingEl) loadingEl.innerHTML = '<div class="chart-loading-text">No data available</div>';
                return;
            }

            // Hide loading, show canvas
            if (loadingEl) loadingEl.style.display = 'none';
            canvasEl.style.display = 'block';

            const ctx = canvasEl.getContext('2d');
            if (charts.saturation) charts.saturation.destroy();

            charts.saturation = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Density', 'Quality', 'Activity'],
                    datasets: [{
                        data: [
                            components.density?.score || 0,
                            components.quality?.score || 0,
                            components.activity?.score || 0
                        ],
                        backgroundColor: ['#3A6746', '#6B4423', '#5c8a69'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function renderAgeChart(ageData) {
            const loadingEl = document.getElementById('ageChartLoading');
            const canvasEl = document.getElementById('ageChart');

            if (!ageData) {
                if (loadingEl) loadingEl.innerHTML = '<div class="chart-loading-text">No data available</div>';
                return;
            }

            if (loadingEl) loadingEl.style.display = 'none';
            canvasEl.style.display = 'block';

            const ctx = canvasEl.getContext('2d');
            if (charts.age) charts.age.destroy();

            const labels = ['Under 18', '18-24', '25-34', '35-44', '45-54', '55-64', '65+'];
            const data = [
                ageData.under18?.percentage || 0,
                ageData.age18to24?.percentage || 0,
                ageData.age25to34?.percentage || 0,
                ageData.age35to44?.percentage || 0,
                ageData.age45to54?.percentage || 0,
                ageData.age55to64?.percentage || 0,
                ageData.age65plus?.percentage || 0
            ];

            charts.age = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Population %',
                        data,
                        backgroundColor: '#3A6746',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 30 }
                    }
                }
            });
        }

        function renderEducationChart(eduData) {
            const loadingEl = document.getElementById('educationChartLoading');
            const canvasEl = document.getElementById('educationChart');

            if (!eduData) {
                if (loadingEl) loadingEl.innerHTML = '<div class="chart-loading-text">No data available</div>';
                return;
            }

            if (loadingEl) loadingEl.style.display = 'none';
            canvasEl.style.display = 'block';

            const ctx = canvasEl.getContext('2d');
            if (charts.education) charts.education.destroy();

            charts.education = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['High School', 'Some College', 'Bachelor\'s', 'Graduate'],
                    datasets: [{
                        data: [
                            eduData.highSchool?.percentage || 0,
                            eduData.someCollege?.percentage || 0,
                            eduData.bachelors?.percentage || 0,
                            eduData.graduate?.percentage || 0
                        ],
                        backgroundColor: ['#e8e8e8', '#b8d4be', '#5c8a69', '#3A6746'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        function renderCommuteChart(commuteData) {
            const loadingEl = document.getElementById('commuteChartLoading');
            const canvasEl = document.getElementById('commuteChart');

            if (!commuteData) {
                if (loadingEl) loadingEl.innerHTML = '<div class="chart-loading-text">No data available</div>';
                return;
            }

            if (loadingEl) loadingEl.style.display = 'none';
            canvasEl.style.display = 'block';

            const ctx = canvasEl.getContext('2d');
            if (charts.commute) charts.commute.destroy();

            charts.commute = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Drive Alone', 'Carpool', 'Transit', 'Walk', 'WFH'],
                    datasets: [{
                        label: 'Workers %',
                        data: [
                            commuteData.driveAlone?.percentage || 0,
                            commuteData.carpool?.percentage || 0,
                            commuteData.publicTransit?.percentage || 0,
                            commuteData.walk?.percentage || 0,
                            commuteData.workFromHome?.percentage || 0
                        ],
                        backgroundColor: '#6B4423',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    indexAxis: 'y'
                }
            });
        }

        function initializeMap() {
            if (!window.reportCenter || !window.reportCompetitors) return;

            const center = window.reportCenter;
            competitorMap = L.map('competitorMap').setView([center.lat, center.lng], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(competitorMap);

            // Add competitor markers
            window.reportCompetitors.forEach(comp => {
                if (comp.location) {
                    const marker = L.marker([comp.location.lat, comp.location.lng])
                        .addTo(competitorMap)
                        .bindPopup(`
                            <strong>${comp.name}</strong><br>
                            ${comp.address || ''}<br>
                            ${comp.rating ? comp.rating.toFixed(1) + ' â˜… (' + (comp.reviews || 0) + ' reviews)' : ''}
                        `);
                }
            });
        }

        function displaySeasonality(data, companySize) {
            const seasonality = data.seasonality;
            const demandSignals = data.demandSignals;

            if (!seasonality && !demandSignals) {
                document.getElementById('seasonalityCard').style.display = 'none';
                return;
            }

            document.getElementById('seasonalityCard').style.display = 'block';

            // Pattern
            const patternMap = {
                'stable': 'Stable',
                'holiday_peak': 'Holiday Peak',
                'january_peak': 'New Year Peak',
                'summer_peak': 'Summer Peak',
                'spring_summer': 'Spring/Summer',
                'back_to_school': 'Back to School',
                'tax_season': 'Tax Season',
                'flu_season': 'Flu Season',
                'morning_peak': 'Morning Peak'
            };
            document.getElementById('seasonalityPattern').textContent =
                patternMap[seasonality?.pattern] || seasonality?.pattern || 'Stable';

            // Impact score
            const impactScore = seasonality?.impactScore || 50;
            document.getElementById('seasonalityImpact').textContent =
                impactScore > 100 ? 'High' : impactScore > 70 ? 'Medium' : 'Low';

            // Momentum
            document.getElementById('seasonalityMomentum').textContent =
                demandSignals?.momentumScore || '-';

            // YoY Trend
            const yoyChange = demandSignals?.yoyChange || 0;
            document.getElementById('seasonalityTrend').textContent =
                (yoyChange >= 0 ? '+' : '') + yoyChange + '%';

            // Peak/off-peak badge
            const badgeContainer = document.getElementById('seasonalityBadge');
            if (seasonality?.isInPeakSeason) {
                badgeContainer.innerHTML = '<span class="peak-badge">ðŸ”¥ Currently in Peak Season</span>';
            } else if (seasonality?.pattern && seasonality.pattern !== 'stable') {
                badgeContainer.innerHTML = '<span class="off-peak-badge">Off-Peak Period</span>';
            } else {
                badgeContainer.innerHTML = '';
            }

            // Recommendation
            if (demandSignals?.recommendations?.timing) {
                document.getElementById('seasonalityRecommendation').style.display = 'block';
                document.getElementById('seasonalityRecommendation').innerHTML =
                    '<strong>ðŸ’¡ Timing Tip:</strong> ' + demandSignals.recommendations.timing;
            } else {
                document.getElementById('seasonalityRecommendation').style.display = 'none';
            }
        }

        window.generatePitchFromMarket = async () => {
            if (!window.currentReportData) {
                showAlert('error', 'No market report data available');
                return;
            }

            const btn = document.getElementById('generatePitchBtn');
            btn.disabled = true;
            btn.innerHTML = 'â³ Preparing pitch data...';

            try {
                const report = window.currentReportData;
                const data = report.data;

                // Prepare prefill data for pitch generator
                const prefillData = {
                    // Location
                    address: [report.location?.city, report.location?.state].filter(Boolean).join(', '),

                    // Industry
                    industry: typeof report.industry === 'object'
                        ? report.industry.display
                        : report.industry,
                    subIndustry: report.industry?.subIndustry || '',

                    // Market data for pitch
                    marketData: {
                        opportunityScore: data.opportunityScore,
                        opportunityLevel: data.opportunityLevel,
                        saturation: data.saturation,
                        saturationScore: data.saturationScore,
                        competitorCount: data.competitorCount,
                        marketSize: data.marketSize,
                        growthRate: data.growthRate,
                        demographics: data.demographics,
                        recommendations: data.recommendations,
                        seasonality: data.seasonality,
                        demandSignals: data.demandSignals,
                        companySize: report.companySize
                    },

                    // Defaults based on market data - use industry-specific values
                    pitchLevel: 3, // Enterprise deck for scale tier
                    monthlyVisits: report.industry?.monthlyCustomers || 100,
                    avgTransaction: report.industry?.avgTransaction || 100,
                    statedProblem: data.recommendations?.targetCustomer
                        ? `reaching ${data.recommendations.targetCustomer}`
                        : 'increasing market share and visibility',

                    // Flag for pitch generator
                    source: 'market_report',
                    marketReportId: report.reportId
                };

                // Store in session and redirect to create-pitch
                sessionStorage.setItem('prefillPitch', JSON.stringify(prefillData));
                sessionStorage.setItem('marketDataForPitch', JSON.stringify(prefillData.marketData));

                window.location.href = '/create-pitch.html?prefill=true&source=market';

            } catch (error) {
                console.error('Error preparing pitch:', error);
                showAlert('error', 'Failed to prepare pitch data');
                btn.disabled = false;
                btn.innerHTML = 'ðŸ“Š Generate Pitch from Market Data';
            }
        };

        // Create a pitch/lead from a competitor in the list
        window.createLeadFromCompetitor = (competitorIndex) => {
            const competitors = window.currentReportData?.data?.competitors || [];
            const competitor = competitors[competitorIndex];

            if (!competitor) {
                showAlert('error', 'Competitor data not found');
                return;
            }

            const report = window.currentReportData;

            // Prepare prefill data with competitor info
            const prefillData = {
                // Competitor info
                businessName: competitor.name,
                address: competitor.address || '',
                googleRating: competitor.rating || null,
                numReviews: competitor.reviews || 0,

                // Industry from current report
                industry: typeof report.industry === 'object'
                    ? report.industry.display
                    : report.industry,
                subIndustry: report.industry?.subIndustry || '',

                // Market context
                marketData: {
                    opportunityScore: report.data?.opportunityScore,
                    opportunityLevel: report.data?.opportunityLevel,
                    saturation: report.data?.saturation,
                    competitorCount: report.data?.competitorCount,
                    marketSize: report.data?.marketSize,
                    growthRate: report.data?.growthRate,
                    demographics: report.data?.demographics,
                    companySize: report.companySize
                },

                // Industry-specific defaults
                monthlyVisits: report.industry?.monthlyCustomers || 100,
                avgTransaction: report.industry?.avgTransaction || 100,

                // Flag for pitch generator
                source: 'market_report',
                marketReportId: report.reportId
            };

            // Store in session and redirect
            sessionStorage.setItem('prefillPitch', JSON.stringify(prefillData));
            sessionStorage.setItem('marketDataForPitch', JSON.stringify(prefillData.marketData));

            showAlert('success', `Creating pitch for ${competitor.name}...`);

            setTimeout(() => {
                window.location.href = '/create-pitch.html?prefill=true&source=competitor';
            }, 500);
        };

        window.downloadPDF = async () => {
            const btn = document.getElementById('pdfButton');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Generating PDF...';

            try {
                // Get report data for filename
                const location = document.getElementById('reportLocation').textContent || 'Market';
                const industry = document.getElementById('reportIndustry').textContent || 'Report';
                const filename = `Market_Report_${location.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;

                // Create a clone of the report section for PDF generation
                const reportSection = document.getElementById('reportSection');
                const pdfContent = document.createElement('div');
                pdfContent.innerHTML = `
                    <div style="padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;">
                        <!-- Header -->
                        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #3A6746;">
                            <h1 style="color: #3A6746; font-size: 28px; margin-bottom: 8px;">Market Intelligence Report</h1>
                            <p style="color: #666; font-size: 16px;">${location} - ${industry}</p>
                            <p style="color: #888; font-size: 12px;">Generated ${new Date().toLocaleDateString()}</p>
                        </div>

                        <!-- Summary Stats -->
                        <div style="display: flex; justify-content: space-around; margin-bottom: 30px; flex-wrap: wrap;">
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; min-width: 120px; margin: 5px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3A6746;">${document.getElementById('statCompetitors').textContent}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Competitors</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; min-width: 120px; margin: 5px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3A6746;">${document.getElementById('statMarketSize').textContent}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Market Size</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; min-width: 120px; margin: 5px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3A6746;">${document.getElementById('statPopulation').textContent}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Population</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; min-width: 120px; margin: 5px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3A6746;">${document.getElementById('statIncome').textContent}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Median Income</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; min-width: 120px; margin: 5px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3A6746;">${document.getElementById('statGrowth').textContent}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Growth Rate</div>
                            </div>
                        </div>

                        ${window.currentReportData?.data?.opportunityScore !== undefined ? `
                        <!-- Opportunity Score -->
                        <div style="background: linear-gradient(135deg, #3A6746 0%, #2d5136 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                            <h3 style="font-size: 12px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">Opportunity Score</h3>
                            <div style="font-size: 42px; font-weight: 700;">${window.currentReportData.data.opportunityScore}</div>
                            <div style="font-size: 16px; margin-top: 4px;">${window.currentReportData.data.opportunityLevel === 'high' ? 'High Opportunity Market' : window.currentReportData.data.opportunityLevel === 'medium' ? 'Moderate Opportunity' : 'Limited Opportunity'}</div>
                            <div style="height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; margin-top: 12px;">
                                <div style="height: 100%; width: ${window.currentReportData.data.opportunityScore}%; background: white; border-radius: 3px;"></div>
                            </div>
                        </div>
                        ` : ''}

                        ${window.currentReportData?.data?.seasonality ? `
                        <!-- Seasonality -->
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                            <h3 style="font-size: 12px; text-transform: uppercase; opacity: 0.9; margin-bottom: 12px;">Seasonality & Timing</h3>
                            <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
                                <div style="text-align: center; padding: 10px;">
                                    <div style="font-size: 20px; font-weight: 700;">${document.getElementById('seasonalityPattern')?.textContent || '-'}</div>
                                    <div style="font-size: 10px; text-transform: uppercase; opacity: 0.85;">Pattern</div>
                                </div>
                                <div style="text-align: center; padding: 10px;">
                                    <div style="font-size: 20px; font-weight: 700;">${document.getElementById('seasonalityMomentum')?.textContent || '-'}</div>
                                    <div style="font-size: 10px; text-transform: uppercase; opacity: 0.85;">Momentum</div>
                                </div>
                                <div style="text-align: center; padding: 10px;">
                                    <div style="font-size: 20px; font-weight: 700;">${document.getElementById('seasonalityTrend')?.textContent || '-'}</div>
                                    <div style="font-size: 10px; text-transform: uppercase; opacity: 0.85;">YoY Trend</div>
                                </div>
                            </div>
                            ${window.currentReportData.data.seasonality.isInPeakSeason ? '<div style="margin-top: 12px; text-align: center;"><span style="background: #f59e0b; color: #1a1a1a; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">Currently in Peak Season</span></div>' : ''}
                        </div>
                        ` : ''}

                        <!-- Competitors Table -->
                        <div style="margin-bottom: 30px;">
                            <h3 style="font-size: 16px; color: #333; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #e8e8e8;">Top Competitors</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="text-align: left; padding: 10px; border-bottom: 2px solid #e8e8e8;">Business Name</th>
                                        <th style="text-align: left; padding: 10px; border-bottom: 2px solid #e8e8e8;">Address</th>
                                        <th style="text-align: center; padding: 10px; border-bottom: 2px solid #e8e8e8;">Rating</th>
                                        <th style="text-align: center; padding: 10px; border-bottom: 2px solid #e8e8e8;">Reviews</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(window.currentReportData?.data?.competitors || []).slice(0, 10).map(comp => `
                                        <tr>
                                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee;"><strong>${comp.name}</strong></td>
                                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; color: #666;">${comp.address || '-'}</td>
                                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center; color: #f59e0b;">${comp.rating ? comp.rating.toFixed(1) + ' â˜…' : '-'}</td>
                                            <td style="padding: 8px 10px; border-bottom: 1px solid #eee; text-align: center;">${comp.reviews || 0}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        ${window.currentReportData?.data?.recommendations ? `
                        <!-- Recommendations -->
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                            <h3 style="font-size: 16px; color: #333; margin-bottom: 16px;">Market Recommendations</h3>

                            <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <div style="font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 4px;">Target Customer</div>
                                <div style="font-size: 14px; color: #333;">${window.currentReportData.data.recommendations.targetCustomer || '-'}</div>
                            </div>

                            ${window.currentReportData.data.recommendations.differentiators?.length ? `
                            <div style="margin-bottom: 16px;">
                                <div style="font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 8px;">Key Differentiators</div>
                                ${window.currentReportData.data.recommendations.differentiators.map(d => `
                                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #3A6746;">
                                        <div style="font-size: 13px; font-weight: 600; color: #333;">${d.title}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">${d.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}

                            ${window.currentReportData.data.recommendations.risks?.length ? `
                            <div>
                                <div style="font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 8px;">Key Risks</div>
                                ${window.currentReportData.data.recommendations.risks.map(r => `
                                    <div style="background: white; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid ${r.level === 'high' ? '#d32f2f' : r.level === 'medium' ? '#f57c00' : '#2e7d32'};">
                                        <div style="font-size: 13px; font-weight: 600; color: #333;">${r.title}</div>
                                        <div style="font-size: 12px; color: #666; margin-top: 4px;">${r.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                            ` : ''}
                        </div>
                        ` : ''}

                        <!-- Footer -->
                        <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e8e8e8; color: #888; font-size: 11px;">
                            <p>Generated by PathSynch Market Intelligence</p>
                            <p>https://pathsynch-pitch-creation.web.app</p>
                        </div>
                    </div>
                `;

                // PDF options
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        letterRendering: true
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'portrait'
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };

                // Generate PDF
                await html2pdf().set(opt).from(pdfContent).save();

                showAlert('success', 'PDF downloaded successfully!');

            } catch (error) {
                console.error('PDF generation error:', error);
                showAlert('error', 'Failed to generate PDF: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };

        window.emailReport = async () => {
            // Prompt for email address
            const email = prompt('Enter email address to send the report:');
            if (!email || !email.includes('@')) {
                if (email !== null) {
                    showAlert('error', 'Please enter a valid email address');
                }
                return;
            }

            const btn = document.getElementById('emailButton');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Generating & Sending...';

            try {
                const location = document.getElementById('reportLocation').textContent || 'Market';
                const industry = document.getElementById('reportIndustry').textContent || 'Report';
                const filename = `Market_Report_${location.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;

                // Build PDF content similar to downloadPDF
                const pdfContent = document.createElement('div');
                pdfContent.innerHTML = `
                    <div style="padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;">
                        <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 3px solid #3A6746;">
                            <h1 style="color: #3A6746; font-size: 28px; margin-bottom: 8px;">Market Intelligence Report</h1>
                            <p style="color: #666; font-size: 16px;">${location} - ${industry}</p>
                            <p style="color: #888; font-size: 12px;">Generated ${new Date().toLocaleDateString()}</p>
                        </div>

                        <div style="display: flex; justify-content: space-around; margin-bottom: 30px; flex-wrap: wrap;">
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; min-width: 120px; margin: 5px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3A6746;">${document.getElementById('statCompetitors').textContent}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Competitors</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; min-width: 120px; margin: 5px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3A6746;">${document.getElementById('statMarketSize').textContent}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Market Size</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; min-width: 120px; margin: 5px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3A6746;">${document.getElementById('statPopulation').textContent}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Population</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; min-width: 120px; margin: 5px;">
                                <div style="font-size: 24px; font-weight: 700; color: #3A6746;">${document.getElementById('statIncome').textContent}</div>
                                <div style="font-size: 11px; color: #666; text-transform: uppercase;">Median Income</div>
                            </div>
                        </div>

                        ${window.currentReportData?.data?.opportunityScore !== undefined ? `
                        <div style="background: linear-gradient(135deg, #3A6746 0%, #2d5136 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                            <h3 style="font-size: 12px; text-transform: uppercase; opacity: 0.9; margin-bottom: 8px;">Opportunity Score</h3>
                            <div style="font-size: 42px; font-weight: 700;">${window.currentReportData.data.opportunityScore}</div>
                            <div style="font-size: 16px; margin-top: 4px;">${window.currentReportData.data.opportunityLevel === 'high' ? 'High Opportunity Market' : window.currentReportData.data.opportunityLevel === 'medium' ? 'Moderate Opportunity' : 'Limited Opportunity'}</div>
                        </div>
                        ` : ''}

                        <div style="margin-bottom: 30px;">
                            <h3 style="font-size: 16px; color: #333; margin-bottom: 12px;">Top Competitors</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="text-align: left; padding: 10px; border-bottom: 2px solid #e8e8e8;">Business</th>
                                        <th style="text-align: center; padding: 10px; border-bottom: 2px solid #e8e8e8;">Rating</th>
                                        <th style="text-align: center; padding: 10px; border-bottom: 2px solid #e8e8e8;">Reviews</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(window.currentReportData?.data?.competitors || []).slice(0, 10).map(c => `
                                        <tr>
                                            <td style="padding: 10px; border-bottom: 1px solid #eee;">${c.name}</td>
                                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #eee;">${c.rating || '-'}</td>
                                            <td style="text-align: center; padding: 10px; border-bottom: 1px solid #eee;">${c.reviewCount || 0}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>

                        <div style="text-align: center; padding-top: 20px; border-top: 1px solid #e8e8e8; color: #888; font-size: 11px;">
                            Generated by PathSynch Market Intelligence<br>
                            pathsynch-pitch-creation.web.app
                        </div>
                    </div>
                `;

                const opt = {
                    margin: 10,
                    filename: filename,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Generate PDF as base64
                const pdfBlob = await html2pdf().set(opt).from(pdfContent).outputPdf('blob');
                const pdfBase64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(pdfBlob);
                });

                // Get the current report ID
                const reportId = window.currentReportData?.reportId || 'new';

                // Send to API
                const response = await fetch(`${API_BASE}/market/reports/${reportId}/email`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        email: email,
                        pdfBase64: pdfBase64,
                        filename: filename,
                        reportData: {
                            location: location,
                            industry: industry,
                            metrics: {
                                competitorCount: document.getElementById('statCompetitors').textContent,
                                saturationLevel: window.currentReportData?.data?.saturation?.level || 'Medium',
                                opportunityScore: window.currentReportData?.data?.opportunityScore
                            }
                        }
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', `Report sent to ${email}`);
                } else {
                    throw new Error(result.message || 'Failed to send email');
                }

            } catch (error) {
                console.error('Email error:', error);
                showAlert('error', 'Failed to send email: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        };

        // ========== TEAM ROLE ==========

        async function loadUserRole() {
            try {
                const response = await fetch(`${API_BASE}/team`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        userRole = result.data.userRole || result.data.role || 'owner';
                        console.log('User role:', userRole);
                    }
                }
            } catch (error) {
                console.error('Error loading user role:', error);
                // Default to owner on error (allows delete)
            }
        }

        // ========== SAVED SEARCHES ==========

        async function loadSavedSearches() {
            try {
                const response = await fetch(`${API_BASE}/market/saved-searches`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                const listEl = document.getElementById('savedSearchesList');
                const countEl = document.getElementById('savedSearchCount');

                if (!result.success || !result.data || result.data.length === 0) {
                    listEl.innerHTML = '<div class="no-saved-searches">No saved searches yet. Generate a report and click "Save Search" to save it for quick access.</div>';
                    countEl.textContent = '';
                    savedSearches = [];
                    return;
                }

                // Store saved searches for dropdown population
                savedSearches = result.data;

                // Extract unique sub-industries from saved searches and add to customSubIndustries
                savedSearches.forEach(search => {
                    if (search.industry && search.subIndustry) {
                        if (!customSubIndustries[search.industry]) {
                            customSubIndustries[search.industry] = [];
                        }
                        // Check if already exists
                        const exists = customSubIndustries[search.industry].some(
                            s => s.value.toLowerCase() === search.subIndustry.toLowerCase()
                        );
                        if (!exists) {
                            customSubIndustries[search.industry].push({
                                value: search.subIndustry,
                                label: search.subIndustry + ' (Saved)',
                                fromSavedSearch: true
                            });
                        }
                    }
                });

                // Refresh the current sub-industry dropdown if an industry is selected
                const currentIndustry = document.getElementById('industry').value;
                if (currentIndustry) {
                    updateSubIndustries();
                }

                countEl.textContent = `${result.data.length} saved`;

                // Only admin, manager, or owner can delete saved searches
                const canDelete = ['owner', 'admin', 'manager'].includes(userRole);

                listEl.innerHTML = result.data.map(search => {
                    const location = [search.city, search.state].filter(Boolean).join(', ');
                    const lastRun = search.lastRunAt
                        ? `Last run: ${new Date(search.lastRunAt._seconds * 1000).toLocaleDateString()}`
                        : 'Never run';

                    return `
                        <div class="saved-search-item">
                            <div class="saved-search-info">
                                <h4>${search.name || location}</h4>
                                <p>${search.industry}${search.subIndustry ? ' / ' + search.subIndustry : ''} â€¢ ${search.companySize || 'medium'} business â€¢ ${lastRun}</p>
                            </div>
                            <div class="saved-search-actions">
                                <button class="run-btn" onclick="runSavedSearch('${search.id}', ${JSON.stringify(search).replace(/"/g, '&quot;')})">Run</button>
                                ${canDelete ? `<button class="delete-btn" onclick="deleteSavedSearch('${search.id}')">Delete</button>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading saved searches:', error);
                document.getElementById('savedSearchesList').innerHTML = '<div class="no-saved-searches" style="color: #d32f2f;">Failed to load saved searches</div>';
            }
        }

        window.saveCurrentSearch = async () => {
            const city = document.getElementById('city').value;
            const state = document.getElementById('state').value;
            const industry = document.getElementById('industry').value;

            if (!city || !state || !industry) {
                showAlert('error', 'Please generate a report first');
                return;
            }

            const btn = document.getElementById('saveSearchButton');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const response = await fetch(`${API_BASE}/market/saved-searches`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${idToken}`
                    },
                    body: JSON.stringify({
                        city,
                        state,
                        zipCode: document.getElementById('zipCode')?.value || null,
                        industry,
                        subIndustry: document.getElementById('subIndustry')?.value || null,
                        companySize: document.getElementById('companySize')?.value || 'medium',
                        radius: parseInt(document.getElementById('radius')?.value) || 5000
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Search saved successfully!');
                    loadSavedSearches(); // Refresh the list
                } else if (response.status === 409) {
                    showAlert('warning', 'This search is already saved');
                } else {
                    throw new Error(result.message || 'Failed to save search');
                }

            } catch (error) {
                console.error('Error saving search:', error);
                showAlert('error', 'Failed to save search: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save Search';
            }
        };

        window.runSavedSearch = async (searchId, searchData) => {
            // Populate form with saved search data
            document.getElementById('city').value = searchData.city || '';
            document.getElementById('state').value = searchData.state || '';
            if (document.getElementById('zipCode')) document.getElementById('zipCode').value = searchData.zipCode || '';
            document.getElementById('industry').value = searchData.industry || '';

            // Update sub-industry dropdown and select value
            if (searchData.industry) {
                updateSubIndustries();
                // Slight delay to let the dropdown populate
                setTimeout(() => {
                    if (searchData.subIndustry && document.getElementById('subIndustry')) {
                        document.getElementById('subIndustry').value = searchData.subIndustry;
                    }
                }, 50);
            }

            if (document.getElementById('companySize')) document.getElementById('companySize').value = searchData.companySize || 'medium';
            if (document.getElementById('radius')) document.getElementById('radius').value = searchData.radius || 5000;

            // Update lastRunAt on the server
            try {
                await fetch(`${API_BASE}/market/saved-searches/${searchId}/run`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });
            } catch (e) {
                // Ignore errors for this update
            }

            // Scroll to form and submit
            document.getElementById('marketForm').scrollIntoView({ behavior: 'smooth' });

            // Small delay to let scroll complete, then submit
            setTimeout(() => {
                document.getElementById('marketForm').dispatchEvent(new Event('submit'));
            }, 500);
        };

        window.deleteSavedSearch = async (searchId) => {
            if (!confirm('Delete this saved search?')) return;

            try {
                const response = await fetch(`${API_BASE}/market/saved-searches/${searchId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert('success', 'Search deleted');
                    loadSavedSearches(); // Refresh the list
                } else {
                    throw new Error(result.message || 'Failed to delete');
                }

            } catch (error) {
                console.error('Error deleting search:', error);
                showAlert('error', 'Failed to delete search');
            }
        };

        async function loadReports() {
            try {
                const response = await fetch(`${API_BASE}/market/reports`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();
                const reportsList = document.getElementById('reportsList');

                if (!result.success || !result.data || result.data.length === 0) {
                    reportsList.innerHTML = '<p style="color: #888; text-align: center; padding: 20px;">No reports yet. Generate your first market report above.</p>';
                    return;
                }

                reportsList.innerHTML = result.data.map(report => {
                    const location = [report.location?.city, report.location?.state].filter(Boolean).join(', ') || 'Unknown';
                    const date = report.createdAt ? new Date(report.createdAt._seconds * 1000).toLocaleDateString() : 'Unknown';

                    return `
                        <div class="report-item" onclick="viewReport('${report.id}')">
                            <div class="report-item-info">
                                <h4>${location}</h4>
                                <p>${report.industry} â€¢ ${report.competitorCount || 0} competitors</p>
                            </div>
                            <div class="report-item-meta">
                                <span class="saturation-badge ${report.saturation || 'medium'}" style="padding: 4px 10px; font-size: 11px;">${(report.saturation || 'medium').toUpperCase()}</span>
                                <div class="date" style="margin-top: 8px;">${date}</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading reports:', error);
                document.getElementById('reportsList').innerHTML = '<p style="color: #d32f2f; text-align: center;">Failed to load reports</p>';
            }
        }

        window.viewReport = async (reportId) => {
            try {
                const response = await fetch(`${API_BASE}/market/reports/${reportId}`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });

                const result = await response.json();

                if (result.success) {
                    displayReport({
                        data: result.data.data,
                        location: result.data.location,
                        industry: result.data.industry,
                        tier: result.data.tier || currentTier,
                        reportId: reportId,
                        companySize: result.data.companySize || currentTier
                    });
                }
            } catch (error) {
                console.error('Error viewing report:', error);
                showAlert('error', 'Failed to load report');
            }
        };

        // Auth listener
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = '/login.html';
                return;
            }

            currentUser = user;
            idToken = await user.getIdToken();

            await loadSubscription();
            await loadReports();
            await loadUserRole();
            await loadSavedSearches();
            await loadCustomSubIndustries();
        });
    </script>
</body>
</html>
